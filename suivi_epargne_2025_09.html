<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi d'√©pargne ‚Äì 10 000 ‚Ç¨ en 3 ans</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b0f19; --panel:#121829; --muted:#95a1b2; --text:#e8eefc; --accent:#5cc8ff; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b0f19,#0d1224);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);padding:16px}
    h1{font-size:28px;margin:0 0 12px}
    h2{font-size:18px;margin:0 0 12px;color:var(--muted)}
    label{font-weight:600;font-size:14px}
    input,select,button,textarea{width:100%;padding:10px 12px;margin-top:6px;margin-bottom:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0e1430;color:var(--text)}
    input:focus,select:focus,button:focus{outline:2px solid var(--accent);outline-offset:1px}
    button{cursor:pointer;font-weight:700;letter-spacing:.2px}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:right}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.02)}
    td:first-child,th:first-child{text-align:left}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(34,197,94,.15);color:#86efac}
    .pill.warn{background:rgba(245,158,11,.15);color:#fde68a}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    .btn-accent{background:linear-gradient(135deg,#2563eb,#22d3ee);border:0}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.2)}
    .footer{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìà Suivi d'√©pargne ‚Äì auto‚Äëh√©berg√©</h1>
    <p class="muted">Objectif par d√©faut : <strong>10‚ÄØ000 ‚Ç¨</strong> en <strong>36 mois</strong>. Tu peux personnaliser ci‚Äëdessous. Les donn√©es sont sauvegard√©es automatiquement dans ton navigateur (localStorage).
    </p>

    <div class="grid">
      <section class="card">
        <h2>Courbe d'√©volution</h2>
        <canvas id="chart" height="140"></canvas>
      </section>

      <section class="card">
        <h2>Param√®tres</h2>
        <div class="row">
          <div>
            <label>Objectif total (‚Ç¨)</label>
            <input id="goal" type="number" min="0" step="100" />
          </div>
          <div>
            <label>Dur√©e (mois)</label>
            <input id="months" type="number" min="1" step="1" />
          </div>
          <div>
            <label>Date de d√©part</label>
            <input id="start" type="month" />
          </div>
          <div>
            <label>Nom du fichier (pour export)</label>
            <input id="slug" placeholder="suivi-epargne" />
          </div>
        </div>
        <div class="btns">
          <button id="apply" class="btn-accent">Mettre √† jour</button>
          <button id="reset" class="btn-ghost">R√©initialiser les montants</button>
          <button id="export" class="btn-ghost">Exporter CSV</button>
          <input id="importFile" type="file" accept=".csv" style="display:none" />
          <button id="import" class="btn-ghost">Importer CSV</button>
        </div>
        <div id="status" class="muted"></div>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <h2>Saisie mensuelle</h2>
      <table id="table">
        <thead>
          <tr>
            <th>Mois</th>
            <th>√Ä verser (th√©orique)</th>
            <th>Vers√© ce mois</th>
            <th>Cumul r√©el</th>
            <th>√âcart vs. objectif</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer" id="summary"></div>
    </section>

    <div class="footer">Fonctionne 100% hors‚Äëligne. Conserve tes donn√©es localement. Pas d'inscription.</div>
  </div>

<script>
const KEY = 'suivi-epargne-v1';
const fmt = n => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0);

function loadState(){
  // D√©part fix√© au 1er septembre 2025
  const def = {goal:10000, months:36, start:`2025-09`, items:[]};
  try{ return Object.assign(def, JSON.parse(localStorage.getItem(KEY))||{});}catch(e){return def}
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

let state = loadState();
let chart;

const el = id => document.getElementById(id);
const tblBody = document.querySelector('#table tbody');

function buildSchedule(){
  // Ensure items length matches months
  state.items = state.items.slice(0, state.months);
  for(let i=state.items.length; i<state.months; i++) state.items.push({paid:0});
}

function monthLabel(startYM, i){
  const [y,m] = startYM.split('-').map(Number);
  const d = new Date(y, (m-1)+i, 1);
  return d.toLocaleDateString('fr-FR', {month:'short', year:'2-digit'});
}

function renderTable(){
  tblBody.innerHTML = '';
  const monthlyTarget = state.goal / state.months;
  let cumReal = 0;
  let cumTarget = 0;
  let lastGap = 0;

  for(let i=0;i<state.months;i++){
    const it = state.items[i];
    cumReal += Number(it.paid||0);
    cumTarget += monthlyTarget;
    const gap = cumReal - cumTarget;

    const tr = document.createElement('tr');
    const month = monthLabel(state.start, i);

    tr.innerHTML = `
      <td>${month}</td>
      <td>${fmt(monthlyTarget)}</td>
      <td><input type="number" step="1" min="0" value="${it.paid||0}" data-i="${i}" style="width:120px"></td>
      <td>${fmt(cumReal)}</td>
      <td>${gap>=0?`<span class="pill ok">+${fmt(Math.abs(gap))}</span>`:`<span class="pill warn">-${fmt(Math.abs(gap))}</span>`}</td>
    `;

    tblBody.appendChild(tr);
    lastGap = gap;
  }

  // inputs listeners
  tblBody.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const i = Number(e.target.dataset.i);
      state.items[i].paid = Number(e.target.value||0);
      saveState();
      renderTable();
      renderChart();
    });
  });

  const total = state.items.reduce((a,b)=>a+Number(b.paid||0),0);
  const pct = Math.min(100, (total/state.goal)*100);
  el('summary').innerHTML = `Total √©pargn√© : <strong>${fmt(total)}</strong> / ${fmt(state.goal)} ‚Äî ${pct.toFixed(1)}% atteint.`;
}

function renderChart(){
  const labels = Array.from({length: state.months}, (_,i)=>monthLabel(state.start,i));
  const monthlyTarget = state.goal / state.months;
  const target = labels.map((_,i)=> monthlyTarget*(i+1));
  const real = [];
  state.items.reduce((acc, it)=>{acc+=Number(it.paid||0); real.push(acc); return acc;},0);

  const ctx = document.getElementById('chart');
  if(chart){ chart.destroy(); }
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[
      {label:'Objectif cumul√©', data:target, borderDash:[6,6], tension:.25},
      {label:'√âpargne r√©elle cumul√©e', data:real, tension:.25}
    ]},
    options:{
      responsive:true,
      interaction:{intersect:false,mode:'index'},
      plugins:{
        legend:{labels:{color:'#c9d1e9'}},
        tooltip:{callbacks:{ label: ctx => `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`}}
      },
      scales:{
        x:{ticks:{color:'#c9d1e9'}},
        y:{ticks:{color:'#c9d1e9'}, beginAtZero:true}
      }
    }
  });
}

function applyUI(){
  el('goal').value = state.goal;
  el('months').value = state.months;
  el('start').value = state.start;
  el('slug').value = (state.slug||'suivi-epargne');
}

function bindActions(){
  el('apply').onclick = ()=>{
    const g = Number(el('goal').value||0);
    const m = Math.max(1, Number(el('months').value||1));
    const s = el('start').value || state.start;
    const slug = el('slug').value||'suivi-epargne';
    state.goal = g; state.months = m; state.start = s; state.slug = slug;
    buildSchedule(); saveState(); renderTable(); renderChart();
    el('status').textContent = `Objectif mis √† jour. Cible mensuelle ‚âà ${fmt(g/m)}.`;
  };

  el('reset').onclick = ()=>{
    state.items.forEach(it=>it.paid=0); saveState(); renderTable(); renderChart();
    el('status').textContent = 'Tous les montants ont √©t√© remis √† 0.';
  };

  el('export').onclick = ()=>{
    const rows = [['Mois','Date','A_verser_theorique','Verse_ce_mois','Cumul_reel','Objectif_cumule']];
    const monthlyTarget = state.goal/state.months;
    let cum=0;
    for(let i=0;i<state.months;i++){
      const paid = Number(state.items[i].paid||0);
      cum += paid; const tgt = monthlyTarget*(i+1);
      const [y,m] = state.start.split('-').map(Number);
      const d = new Date(y,(m-1)+i,1).toISOString().slice(0,10);
      rows.push([i+1,d,monthlyTarget.toFixed(2),paid.toFixed(2),cum.toFixed(2),tgt.toFixed(2)]);
    }
    const csv = rows.map(r=>r.join(';')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${state.slug||'suivi-epargne'}.csv`;
    a.click();
  };

  el('import').onclick = ()=> el('importFile').click();
  el('importFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    const lines = txt.trim().split(/\r?\n/).slice(1); // skip header
    const paid = [];
    for(const line of lines){ const parts = line.split(';'); paid.push(Number(parts[3]||0)); }
    if(paid.length){
      state.items = paid.slice(0, state.months).map(v=>({paid:v}));
      buildSchedule(); saveState(); renderTable(); renderChart();
      el('status').textContent = `Import√© ${paid.length} lignes depuis le CSV.`;
    }
    e.target.value = '';
  });
}

// Init
buildSchedule();
applyUI();
bindActions();
renderTable();
renderChart();
</script>
</body>
</html>
